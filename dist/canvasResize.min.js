!function(a){function b(a,b){this.file=a,this.options=d.extend({},e,b),this._defaults=e,this._name=c,this.init()}var c="canvasResize",d={newsize:function(a,b,c,d,e){var f=e?"h":"";if(c&&a>c||d&&b>d){var g=a/b;(g>=1||0===d)&&c&&!e?(a=c,b=c/g>>0):e&&c/d>=g?(a=c,b=c/g>>0,f="w"):(a=d*g>>0,b=d)}return{width:a,height:b,cropped:f}},dataURLtoBlob:function(a){for(var b=a.split(",")[0].split(":")[1].split(";")[0],c=atob(a.split(",")[1]),d=new ArrayBuffer(c.length),e=new Uint8Array(d),f=0;f<c.length;f++)e[f]=c.charCodeAt(f);var g=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder;return g?(g=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder),g.append(d),g.getBlob(b)):g=new Blob([d],{type:b})},detectSubsampling:function(a){var b=a.width,c=a.height;if(b*c>1048576){var d=document.createElement("canvas");d.width=d.height=1;var e=d.getContext("2d");return e.drawImage(a,-b+1,0),0===e.getImageData(0,0,1,1).data[3]}return!1},rotate:function(a,b){var c={1:{90:6,180:3,270:8},2:{90:7,180:4,270:5},3:{90:8,180:1,270:6},4:{90:5,180:2,270:7},5:{90:2,180:7,270:4},6:{90:3,180:8,270:1},7:{90:4,180:5,270:2},8:{90:1,180:6,270:3}};return c[a][b]?c[a][b]:a},transformCoordinate:function(a,b,c,d){switch(d){case 5:case 6:case 7:case 8:a.width=c,a.height=b;break;default:a.width=b,a.height=c}var e=a.getContext("2d");switch(d){case 1:break;case 2:e.translate(b,0),e.scale(-1,1);break;case 3:e.translate(b,c),e.rotate(Math.PI);break;case 4:e.translate(0,c),e.scale(1,-1);break;case 5:e.rotate(.5*Math.PI),e.scale(1,-1);break;case 6:e.rotate(.5*Math.PI),e.translate(0,-c);break;case 7:e.rotate(.5*Math.PI),e.translate(b,-c),e.scale(-1,1);break;case 8:e.rotate(-.5*Math.PI),e.translate(-b,0)}},detectVerticalSquash:function(a,b,c){var d=document.createElement("canvas");d.width=1,d.height=c;var e=d.getContext("2d");e.drawImage(a,0,0);for(var f=e.getImageData(0,0,1,c).data,g=0,h=c,i=c;i>g;){var j=f[4*(i-1)+3];0===j?h=i:g=i,i=h+g>>1}var k=i/c;return 0===k?1:k},callback:function(a){return a},extend:function(){var a=arguments[0]||{},b=1,c=arguments.length,e=!1;a.constructor===Boolean&&(e=a,a=arguments[1]||{}),1===c&&(a=this,b=0);for(var f;c>b;b++)if(null!==(f=arguments[b]))for(var g in f)a!==f[g]&&(e&&"object"==typeof f[g]&&a[g]?d.extend(a[g],f[g]):void 0!==f[g]&&(a[g]=f[g]));return a}},e={width:300,height:0,crop:!1,quality:80,rotate:0,callback:d.callback};b.prototype={init:function(){var a=this,b=this.file,c=new FileReader;c.onloadend=function(c){var e=c.target.result,f=atob(e.split(",")[1]),g=new BinaryFile(f,0,f.length),h=EXIF.readFromBinaryFile(g),i=new Image;i.onload=function(c){var e=h.Orientation||1;e=d.rotate(e,a.options.rotate);var f=e>=5&&8>=e?d.newsize(i.height,i.width,a.options.width,a.options.height,a.options.crop):d.newsize(i.width,i.height,a.options.width,a.options.height,a.options.crop),g=i.width,j=i.height,k=f.width,l=f.height,m=document.createElement("canvas"),n=m.getContext("2d");n.save(),d.transformCoordinate(m,k,l,e),d.detectSubsampling(i)&&(g/=2,j/=2);var o=1024,p=document.createElement("canvas");p.width=p.height=o;for(var q=p.getContext("2d"),r=d.detectVerticalSquash(i,g,j),s=0;j>s;){for(var t=s+o>j?j-s:o,u=0;g>u;){var v=u+o>g?g-u:o;q.clearRect(0,0,o,o),q.drawImage(i,-u,-s);var w=Math.floor(u*k/g),x=Math.ceil(v*k/g),y=Math.floor(s*l/j/r),z=Math.ceil(t*l/j/r);n.drawImage(p,0,0,v,t,w,y,x,z),u+=o}s+=o}n.restore(),p=q=null;var A=document.createElement("canvas");A.width="h"===f.cropped?l:k,A.height="w"===f.cropped?k:l;var B="h"===f.cropped?.5*(l-k):0,C="w"===f.cropped?.5*(k-l):0;if(newctx=A.getContext("2d"),newctx.drawImage(m,B,C,k,l),console.log(b,b.type),"image/png"===b.type)var D=A.toDataURL(b.type);else var D=A.toDataURL("image/jpeg",.01*a.options.quality);a.options.callback(D,A.width,A.height)},i.src=e},c.readAsDataURL(b)}},a[c]=function(a,c){return"string"==typeof a?d[a](c):void new b(a,c)}}(window);