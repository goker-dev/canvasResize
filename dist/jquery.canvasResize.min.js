!function(a){function b(b,d){this.file=b,this.options=a.extend({},e,d),this._defaults=e,this._name=c,this.init()}var c="canvasResize",d={newsize:function(a,b,c,d,e){var f=e?"h":"";if(c&&a>c||d&&b>d){var g=a/b;(g>=1||0===d)&&c&&!e?(a=c,b=c/g>>0):e&&c/d>=g?(a=c,b=c/g>>0,f="w"):(a=d*g>>0,b=d)}return{width:a,height:b,cropped:f}},dataURLtoBlob:function(a){for(var b=a.split(",")[0].split(":")[1].split(";")[0],c=atob(a.split(",")[1]),d=new ArrayBuffer(c.length),e=new Uint8Array(d),f=0;f<c.length;f++)e[f]=c.charCodeAt(f);var g=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder;return g?(g=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder),g.append(d),g.getBlob(b)):g=new Blob([d],{type:b})},detectSubsampling:function(a){var b=a.width,c=a.height;if(b*c>1048576){var d=document.createElement("canvas");d.width=d.height=1;var e=d.getContext("2d");return e.drawImage(a,-b+1,0),0===e.getImageData(0,0,1,1).data[3]}return!1},rotate:function(a,b){var c={1:{90:6,180:3,270:8},2:{90:7,180:4,270:5},3:{90:8,180:1,270:6},4:{90:5,180:2,270:7},5:{90:2,180:7,270:4},6:{90:3,180:8,270:1},7:{90:4,180:5,270:2},8:{90:1,180:6,270:3}};return c[a][b]?c[a][b]:a},transformCoordinate:function(a,b,c,d){switch(d){case 5:case 6:case 7:case 8:a.width=c,a.height=b;break;default:a.width=b,a.height=c}var e=a.getContext("2d");switch(d){case 1:break;case 2:e.translate(b,0),e.scale(-1,1);break;case 3:e.translate(b,c),e.rotate(Math.PI);break;case 4:e.translate(0,c),e.scale(1,-1);break;case 5:e.rotate(.5*Math.PI),e.scale(1,-1);break;case 6:e.rotate(.5*Math.PI),e.translate(0,-c);break;case 7:e.rotate(.5*Math.PI),e.translate(b,-c),e.scale(-1,1);break;case 8:e.rotate(-.5*Math.PI),e.translate(-b,0)}},detectVerticalSquash:function(a,b,c){var d=document.createElement("canvas");d.width=1,d.height=c;var e=d.getContext("2d");e.drawImage(a,0,0);for(var f=e.getImageData(0,0,1,c).data,g=0,h=c,i=c;i>g;){var j=f[4*(i-1)+3];0===j?h=i:g=i,i=h+g>>1}var k=i/c;return 0===k?1:k},callback:function(a){return a}},e={width:300,height:0,crop:!1,quality:80,callback:d.callback};b.prototype={init:function(){var b=this,c=this.file,e=new FileReader;e.onloadend=function(e){var f=e.target.result,g=new Image;g.onload=function(e){a(g).exifLoadFromDataURL(function(){var e=a(g).exif("Orientation")[0]||1;e=d.rotate(e,b.options.rotate);var f=e>=5&&8>=e?d.newsize(g.height,g.width,b.options.width,b.options.height,b.options.crop):d.newsize(g.width,g.height,b.options.width,b.options.height,b.options.crop),h=g.width,i=g.height,j=f.width,k=f.height,l=document.createElement("canvas"),m=l.getContext("2d");m.save(),d.transformCoordinate(l,j,k,e),d.detectSubsampling(g)&&(h/=2,i/=2);var n=1024,o=document.createElement("canvas");o.width=o.height=n;for(var p=o.getContext("2d"),q=d.detectVerticalSquash(g,h,i),r=0;i>r;){for(var s=r+n>i?i-r:n,t=0;h>t;){var u=t+n>h?h-t:n;p.clearRect(0,0,n,n),p.drawImage(g,-t,-r);var v=Math.floor(t*j/h),w=Math.ceil(u*j/h),x=Math.floor(r*k/i/q),y=Math.ceil(s*k/i/q);m.drawImage(o,0,0,u,s,v,x,w,y),t+=n}r+=n}m.restore(),o=p=null;var z=document.createElement("canvas");z.width="h"===f.cropped?k:j,z.height="w"===f.cropped?j:k;var A="h"===f.cropped?.5*(k-j):0,B="w"===f.cropped?.5*(j-k):0;if(newctx=z.getContext("2d"),newctx.drawImage(l,A,B,j,k),"image/png"===c.type)var C=z.toDataURL(c.type);else var C=z.toDataURL("image/jpeg",.01*b.options.quality);b.options.callback(C,j,k)})},g.src=f},e.readAsDataURL(c)}},a[c]=function(a,c){return"string"==typeof a?d[a](c):void new b(a,c)}}(jQuery);